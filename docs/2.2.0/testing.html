<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Testing upgradeable projects · ZeppelinOS</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="Testing upgradeable projects · ZeppelinOS"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.zeppelinos.org/index.html"/><meta property="og:description" content="When working with ZeppelinOS, you can test your contracts as you usually do. That is, you can manually deploy your logic contracts, and test them just like any other contract. However, when using ZeppelinOS, you are dealing with upgradeable instances. Of course, you could use ZeppelinOS at a lower level programmatically in your tests but this could be rather cumbersome."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-102575245-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100,200,300,400,500,700,400italic,700italic"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible doc"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.svg" alt="ZeppelinOS"/></a><a href="/versions.html"><h3>2.2.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/2.2.0/start.html" target="_self">Quickstart</a></li><li class=""><a href="/docs/2.2.0/apis.html" target="_self">Reference</a></li><li class=""><a href="https://blog.zeppelinos.org" target="_self">Blog</a></li><li class=""><a href="https://forum.zeppelin.solutions" target="_self">Forum</a></li><li class=""><a href="https://github.com/zeppelinos" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>GUIDES</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>OVERVIEW</h3><ul><li class="navListItem"><a class="navItem" href="/docs/2.2.0/start.html">ZeppelinOS</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/new_2.html">What&#x27;s new in ZeppelinOS 2.0</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/new_2.2.html">What&#x27;s new in ZeppelinOS 2.2</a></li></ul></div><div class="navGroup navGroupActive"><h3>QUICKSTART</h3><ul><li class="navListItem"><a class="navItem" href="/docs/2.2.0/zepkit.html">ZepKit</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/deploying.html">Deploying your first project</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/upgrading.html">Upgrading your project</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/linking.html">Linking to EVM packages</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/publishing.html">Publishing an EVM package</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/vouching.html">Vouching for EVM packages</a></li></ul></div><div class="navGroup navGroupActive"><h3>GUIDES</h3><ul><li class="navListItem"><a class="navItem" href="/docs/2.2.0/writing_contracts.html">Writing upgradeable contracts</a></li><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/docs/2.2.0/testing.html">Testing upgradeable projects</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/erc20_onboarding.html">Onboarding ERC20 tokens</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/upgrades_governance.html">Upgrades governance</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/zos_lib.html">Using the ZeppelinOS programmatic library</a></li></ul></div><div class="navGroup navGroupActive"><h3>ADVANCED TOPICS</h3><ul><li class="navListItem"><a class="navItem" href="/docs/2.2.0/faq.html">Frequently asked questions</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/configuration.html">Configuration Files</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/architecture.html">Contracts Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/pattern.html">ZeppelinOS Upgrades Pattern</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/token_mechanics.html">ZEP Token Mechanics</a></li><li class="navListItem"><a class="navItem" href="/docs/2.2.0/whitepaper.html">Whitepaper</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>Testing upgradeable projects</h1></header><article><div><span><p>When working with ZeppelinOS, you can test your contracts as you usually do. That is, you can manually deploy your logic contracts, and test them just like any other contract. However, when using ZeppelinOS, you are dealing with upgradeable instances. Of course, you could use ZeppelinOS at a lower level programmatically in your tests but this could be rather cumbersome.</p>
<p>Instead, you can use specifically designed ZeppelinOS tools that automatically set up your entire project in your testing environment. This allows you to replicate the same set of contracts that manage your project for each test you run.</p>
<p>The <code>zos</code> package provides a <code>TestHelper()</code> function to retrieve your project structure from the <code>zos.json</code> file and deploy everything to the current test network. All the contracts that you have registered via <code>zos add</code>, plus all the contracts provided by the EVM packages you have linked, will be available. The returned project object (either a <a href="https://github.com/zeppelinos/zos/blob/v2.2.0/packages/lib/src/project/ProxyAdminProject.ts"><code>ProxyAdminProject</code></a> or an <a href="https://github.com/zeppelinos/zos/blob/v2.2.0/packages/lib/src/project/AppProject.ts"><code>AppProject</code></a>) provides convenient methods for creating upgradeable instances of your contracts, which you can use within your tests. Let's see how this would work in a simple project.</p>
<h2><a class="anchor" aria-hidden="true" id="setting-up-a-sample-project"></a><a href="#setting-up-a-sample-project" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up a sample project</h2>
<p>The following section describes a succinct way in how a simple ZeppelinOS project can be set up. If you already have a project set up, you may skip to the next section.</p>
<p><em>If you don't understand what's going on in this section, please refer to the Quickstart guides of the documentation, specifically the <a href="https://docs.zeppelinos.org/docs/deploying.html">Deploying your first project</a>, <a href="https://docs.zeppelinos.org/docs/upgrading.html">Upgrading your project</a> and <a href="https://docs.zeppelinos.org/docs/linking.html">Linking to EVM packages</a> guides. These guides provide detailed explanations on how a basic ZeppelinOS project works.</em></p>
<p>Create a new project by running:</p>
<pre><code class="hljs css console">mkdir my-project
cd my-project
npm init --yes
npm install zos zos-lib openzeppelin-eth truffle chai
</code></pre>
<p>Now, run:</p>
<pre><code class="hljs css console">npx zos init my-project
</code></pre>
<p>Let's add a simple contract to the project, create the file <code>contracts/Sample.sol</code>:</p>
<pre><code class="hljs css solidity"><span class="hljs-keyword">pragma</span> solidity ^<span class="hljs-number">0.5</span>.0;

contract Sample {
  <span class="hljs-built_in">function</span> greet() <span class="hljs-keyword">public</span> <span class="hljs-keyword">pure</span> returns (<span class="hljs-built_in">string</span> memory) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"A sample"</span>;
  }
}
</code></pre>
<p>Now, add your contract to the ZeppelinOS project:</p>
<pre><code class="hljs css console">npx zos add Sample
</code></pre>
<p>And link your ZeppelinOS project to the <code>openzeppelin-eth</code> EVM package:</p>
<pre><code class="hljs"><span class="hljs-attribute">npx zos link openzeppelin-eth</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="writing-the-test-script"></a><a href="#writing-the-test-script" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing the test script</h2>
<blockquote>
<p>This test is written in ES5 Javascript. If you'd like to use ES6 syntax instead, make sure you <a href="https://docs.zeppelinos.org/docs/faq.html#how-do-i-use-es6-javascript-syntax-in-my-tests">set up babel in your project</a>.</p>
</blockquote>
<p>Now, let's create the test file <code>test/Sample.test.js</code>:</p>
<pre><code class="hljs css javascript"><span class="hljs-keyword">const</span> { TestHelper } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zos'</span>);
<span class="hljs-keyword">const</span> { Contracts, ZWeb3 } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zos-lib'</span>);

ZWeb3.initialize(web3.currentProvider);

<span class="hljs-keyword">const</span> Sample = Contracts.getFromLocal(<span class="hljs-string">'Sample'</span>);
<span class="hljs-keyword">const</span> ERC20 = Contracts.getFromNodeModules(<span class="hljs-string">'openzeppelin-eth'</span>, <span class="hljs-string">'ERC20'</span>);

<span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).should();

contract(<span class="hljs-string">'Sample'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

  beforeEach(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.project = <span class="hljs-keyword">await</span> TestHelper();
  })

  it(<span class="hljs-string">'should create a proxy'</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.project.createProxy(Sample);
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> proxy.methods.greet().call();
    result.should.eq(<span class="hljs-string">'A sample'</span>);
  })

  it(<span class="hljs-string">'should create a proxy for the EVM package'</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.project.createProxy(ERC20, { <span class="hljs-attr">contractName</span>: <span class="hljs-string">'StandaloneERC20'</span>, <span class="hljs-attr">packageName</span>: <span class="hljs-string">'openzeppelin-eth'</span> });
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> proxy.methods.totalSupply().call();
    result.should.eq(<span class="hljs-string">'0'</span>);
  })
})
</code></pre>
<p>Next, modify your <code>package.json</code> file to include the following script:</p>
<pre><code class="hljs css json">"test": "truffle test"
</code></pre>
<p>And run the test in your console with:</p>
<pre><code class="hljs css console">npm test
</code></pre>
<p>That's it! Now, let's look at what we just did in more detail.</p>
<h2><a class="anchor" aria-hidden="true" id="understanding-the-test-script"></a><a href="#understanding-the-test-script" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Understanding the test script</h2>
<p>We first require <code>TestHelper</code> from <code>zos</code>. This helper facilitates the creation of a project object that will set up the entire ZeppelinOS project within a test environment.</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> { TestHelper } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zos'</span>);
</code></pre>
<p>We are also requiring <code>Contracts</code> and <code>ZWeb3</code> from <code>zos-lib</code>. <code>Contracts</code> helps us retrieve compiled contract artifacts, while <code>ZWeb3</code> is needed to set up our Web3 provider to ZeppelinOS.</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> { Contracts, ZWeb3 } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zos-lib'</span>);

ZWeb3.initialize(web3.currentProvider);

<span class="hljs-keyword">const</span> Sample = Contracts.getFromLocal(<span class="hljs-string">'Sample'</span>);
<span class="hljs-keyword">const</span> ERC20 = Contracts.getFromNodeModules(<span class="hljs-string">'openzeppelin-eth'</span>, <span class="hljs-string">'ERC20'</span>);
</code></pre>
<p>We then invoke <code>TestHelper</code> in the test, optionally including a set of options to be used when deploying the contracts (such as <code>from</code>, <code>gas</code>, and <code>gasPrice</code>):</p>
<pre><code class="hljs css js">beforeEach(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.project = <span class="hljs-keyword">await</span> TestHelper()
});
</code></pre>
<p>And finally, we add the tests themselves. Notice how each test first creates a upgradeable instance for each contract:</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.project.createProxy(Sample);
</code></pre>
<p>The <a href="https://github.com/zeppelinos/zos/blob/master/packages/lib/src/project/BaseSimpleProject.ts#L96">createProxy</a> method of the project accepts an additional object parameter in which you can specify an initializer function with arguments, just as you would by using the regular <code>zos create</code> command from the CLI, but due to the simplicity of this example, it's not necessary in our case. If you would need to pass parameters though, you would do so like this:</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.project.createProxy(Sample, {
  <span class="hljs-attr">initMethod</span>: <span class="hljs-string">'initialize'</span>,
  <span class="hljs-attr">initArgs</span>: [<span class="hljs-number">42</span>]
});
</code></pre>
<p>This is assuming our <code>Sample</code> contract had an <code>initialize</code> function with one <code>uint256</code> parameter, which it doesn't. The above code simply illustrates how you would create the upgradeable instance if it had an <code>initialize</code> function.</p>
<p>Continuing with our example, notice that the way we interact with the contracts is by using their <code>methods</code> object. This is because ZeppelinOS uses Web3 1.0 Contract interface:</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> proxy.methods.totalSupply().call();
</code></pre>
<p>This is how you should write tests for your ZeppelinOS projects. The project object provided by <code>TestHelper</code> wraps all of ZeppelinOS programmatic interface in a way that is very convenient to use in tests. By running tests in this way, you make sure that you are testing your contracts with the exact set of conditions that they would have in production, after you deploy them with ZeppelinOS.</p>
<h2><a class="anchor" aria-hidden="true" id="calling-initialize-functions-manually-in-your-tests"></a><a href="#calling-initialize-functions-manually-in-your-tests" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Calling initialize functions manually in your tests</h2>
<p>Sometimes, there are situations where a contract
has functions that have matching names, but different arities.
Here's an example of a <code>TimedCrowdsale</code> contract that inherits
from <code>Crowdsale</code> which results in a contract that has two
<code>initialize</code> functions with different arities:</p>
<pre><code class="hljs css solidity">contract TimedCrowdsale is Crowdsale {

  initialize(uint256 <span class="hljs-variable">_openingTime</span>, uint256 <span class="hljs-variable">_closingTime</span>) public initializer {
    Crowdsale.initialize(<span class="hljs-variable">_rate</span>, <span class="hljs-variable">_wallet</span>, <span class="hljs-variable">_token</span>);
  }
}

contract Crowdsale {

  initialize(uint256 <span class="hljs-variable">_rate</span>, address <span class="hljs-variable">_wallet</span>, ERC20 <span class="hljs-variable">_token</span>) public initializer {
    <span class="hljs-comment">// does something</span>
  }
}
</code></pre>
<p>This means that calls to contracts with more than one function named <code>initialize</code>,
as is the case with some contracts from OpenZeppelin (e.g., TimedCrowdsale),
may revert if you call <code>initialize</code> directly from Truffle. <code>zos create</code> handles
this correctly as it encodes the parameters. However, for your unit tests you will
need to call <code>initialize</code> manually.</p>
<p>As of version 5, Truffle has the ability to
overcome the problem depicted above. That is, you can call functions with matching
names that have different arities in Javascript by using the methods property of Truffle Contract.</p>
<p>To call TimedCrowdsale's initialize function, use the following syntax:</p>
<pre><code class="hljs">timedCrowadsale.methods[<span class="hljs-string">'initialize(uint256,uint256)'</span>](<span class="hljs-link">openingTime, closingTime</span>);
</code></pre>
<p>And to call Crowdsale's initialize function,</p>
<pre><code class="hljs">timedCrowadsale.methods[<span class="hljs-string">'initialize(uint256,address,address)'</span>](<span class="hljs-link">rate, wallet, token</span>);
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="writing_contracts.html">← Writing upgradeable contracts</a><a class="docs-next button" href="erc20_onboarding.html">Onboarding ERC20 tokens →</a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/symbol-zeppelin.png" alt="ZeppelinOS" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/start.html">Guides</a><a href="/docs/apis.html">Reference</a></div><div><h5>Community</h5><a href="https://forum.zeppelin.solutions/" target="_blank">Forum</a><a href="https://t.me/zeppelinos/" target="_blank">Telegram chat</a></div><div><h5>More</h5><a href="https://zeppelinos.org">Main Site</a><a href="https://blog.zeppelinos.org">Blog</a><a href="https://github.com/zeppelinos">GitHub</a></div></section><a href="https://zeppelinos.org" target="_blank" class="fbOpenSource"><img src="/img/logo.svg" alt="ZeppelinOS" width="170" height="45"/></a><section class="copyright">Copyright © 2017-present ZeppelinOS Global</section><section class="report-bugs"><a href="https://github.com/zeppelinos/zos/issues/new?labels=kind:documentation">Report a bug on this site</a></section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
              var search = docsearch({
                
                apiKey: '8d0b5afbba49947d9efb5659d1b08df7',
                indexName: 'zeppelinos',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>