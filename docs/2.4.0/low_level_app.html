<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Low level upgradeable app · ZeppelinOS</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="Low level upgradeable app · ZeppelinOS"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.zeppelinos.org/index.html"/><meta property="og:description" content="&gt; **Note**: this guide shows a low-level method for operating a complex upgradeable decentralized application. For a CLI-aided developer experience, use the [higher-level CLI guide](setup.html)."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-102575245-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100,200,300,400,500,700,400italic,700italic"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible doc"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.svg" alt="ZeppelinOS"/></a><a href="/versions.html"><h3>2.4.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/2.4.0/start.html" target="_self">Quickstart</a></li><li class=""><a href="/docs/2.4.0/apis.html" target="_self">Reference</a></li><li class=""><a href="https://blog.zeppelinos.org" target="_self">Blog</a></li><li class=""><a href="https://forum.zeppelin.solutions" target="_self">Forum</a></li><li class=""><a href="https://github.com/zeppelinos" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>Low level upgradeable app</h1></header><article><div><span><blockquote>
<p><strong>Note</strong>: this guide shows a low-level method for operating a complex upgradeable decentralized application. For a CLI-aided developer experience, use the <a href="setup.html">higher-level CLI guide</a>.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong>: for a fully working project with this example, see the <a href="https://github.com/zeppelinos/zos-lib/tree/master/examples/complex"><code>examples/complex</code></a> folder of the <code>zos-lib</code> repository.</p>
</blockquote>
<p>Most real-world applications require more than a single smart contract. In this guide we will explore how to build an upgradeable app with multiple smart contracts and how to use the ZeppelinOS on-chain standard library.</p>
<h3><a class="anchor" aria-hidden="true" id="getting-started"></a><a href="#getting-started" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting started</h3>
<p>Imagine we want to build a simple donation application where we give donors some sort of recognition, and we want for it to be upgradable. First, we install the ZeppelinOS library:</p>
<pre><code class="hljs css sh">npm install zos-lib
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="create-the-app"></a><a href="#create-the-app" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create the app</h3>
<p>Next, we need the App contract of the <a href="https://github.com/zeppelinos/zos-lib"><code>ZeppelinOS Library</code></a>.
This contract will live in the blockchain and manage the different versions of our smart contracts.</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> { App } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zos-lib'</span>)
<span class="hljs-keyword">const</span> initialVersion = <span class="hljs-string">'0.0.1'</span>
<span class="hljs-keyword">await</span> App.deploy(initialVersion)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="create-the-contract"></a><a href="#create-the-contract" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create the contract</h3>
<p>An initial version of the Solidity contract could look like:</p>
<pre><code class="hljs css sol">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.21</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">"openzeppelin-zos/contracts/ownership/Ownable.sol"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"openzeppelin-zos/contracts/math/SafeMath.sol"</span>;

contract DonationsV0 is Ownable {
  using SafeMath <span class="hljs-keyword">for</span> uint256;

  <span class="hljs-comment">// Keeps a mapping of total donor balances</span>
  mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> uint256) public donorBalances;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">donate</span>(<span class="hljs-params"></span>) <span class="hljs-title">payable</span> <span class="hljs-title">public</span> </span>{
    <span class="hljs-built_in">require</span>(msg.value &gt; <span class="hljs-number">0</span>);

    <span class="hljs-comment">// Update user donation balance</span>
    donorBalances[msg.sender] = donorBalances[msg.sender].add(msg.value);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDonationBalance</span>(<span class="hljs-params">address _donor</span>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> (<span class="hljs-params">uint256</span>) </span>{
    <span class="hljs-keyword">return</span> donorBalances[_donor];
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withdraw</span>(<span class="hljs-params">address _wallet</span>) <span class="hljs-title">onlyOwner</span> </span>{
    <span class="hljs-comment">// Withdraw all donated funds</span>
    _wallet.transfer(<span class="hljs-keyword">this</span>.balance);
  }
}
</code></pre>
<p>Now, let's deploy the first version of our contract. To do so, we register its implementation in the <code>App</code> and then request to create a new proxy for it:</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> contractName = <span class="hljs-string">"Donations"</span>;
<span class="hljs-keyword">const</span> DonationsV0 = Contracts.getFromLocal(<span class="hljs-string">'DonationsV0'</span>)
<span class="hljs-keyword">await</span> app.setImplementation(DonationsV0, contractName)
<span class="hljs-keyword">const</span> donationsV0 = <span class="hljs-keyword">await</span> app.createProxy(DonationsV0, contractName, <span class="hljs-string">'initialize'</span>, [owner])
</code></pre>
<p>Remember that the proxy is the contract that will receive the calls and hold the storage, while delegating its behavior to the implementation contract, enabling us to upgrade it.</p>
<h3><a class="anchor" aria-hidden="true" id="link-a-standard-library"></a><a href="#link-a-standard-library" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Link a standard library</h3>
<p>Now let's suppose we want to give some sort of retribution to the donors, so we mint new <a href="http://erc721.org/">ERC721</a> cryptocollectibles for each donation.</p>
<p>In order to do this, we link the <a href="stdlib.html">ZeppelinOS standard library</a> to our application by running:</p>
<pre><code class="hljs css sh">npm install openzeppelin-zos
</code></pre>
<p>Done! Now we can easily mint non-fungible tokens from our smart contract:</p>
<pre><code class="hljs css sol">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.21</span>;

<span class="hljs-meta"><span class="hljs-meta-keyword">import</span> "./DonationsV0.sol";</span>
<span class="hljs-meta"><span class="hljs-meta-keyword">import</span> "openzeppelin-zos/contracts/token/ERC721/MintableERC721Token.sol";</span>

contract DonationsV1 <span class="hljs-keyword">is</span> DonationsV0 {
  using SafeMath <span class="hljs-keyword">for</span> uint256;

  MintableERC721Token <span class="hljs-keyword">public</span> token;
  uint256 <span class="hljs-keyword">public</span> numEmittedTokens;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setToken</span><span class="hljs-params">(MintableERC721Token _token)</span> <span class="hljs-title">external</span> </span>{
    require(_token != address(<span class="hljs-number">0</span>));
    require(token == address(<span class="hljs-number">0</span>));
    token = _token;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">donate</span><span class="hljs-params">()</span> <span class="hljs-title">payable</span> <span class="hljs-title">public</span> </span>{
    <span class="hljs-keyword">super</span>.donate();
    token.mint(msg.sender, numEmittedTokens);
    numEmittedTokens = numEmittedTokens.add(<span class="hljs-number">1</span>);
  }
}
</code></pre>
<p>Notice that by doing this, our contract will interact directly with the on-chain ZeppelinOS standard library, so there is no need to deploy nor maintain the <code>MintableERC721Token</code> contract ourselves.</p>
<h3><a class="anchor" aria-hidden="true" id="upgrade-to-the-new-version"></a><a href="#upgrade-to-the-new-version" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrade to the new version</h3>
<p>To upgrade our app, we need to create a new version and reference the ZeppelinOS standard library release</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> stdlibAddress = <span class="hljs-string">"0x3bd95b5a003481b801010bcde4f7e0a32a925deb"</span> <span class="hljs-comment">// mainnet release</span>
<span class="hljs-keyword">const</span> newVersion = <span class="hljs-string">'0.0.2'</span>
<span class="hljs-keyword">await</span> app.newVersion(newVersion, <span class="hljs-keyword">await</span> getStdLib(stlibAddress))
</code></pre>
<p>Next, we register the new implementation of our donations contract:</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> DonationsV1 = Contracts.getFromLocal(<span class="hljs-string">'DonationsV1'</span>)
<span class="hljs-keyword">await</span> app.setImplementation(DonationsV1, contractName)
</code></pre>
<p>And upgrade the proxy:</p>
<pre><code class="hljs css js"><span class="hljs-keyword">await</span> app.upgradeProxy(donationsV0.address, <span class="hljs-literal">null</span>, contractName)
<span class="hljs-comment">// We wrap the previous proxy address with the new interface</span>
donationsV1 = DonationsV1.at(donationsV0.address)
</code></pre>
<p>Then we create a proxy to the standard library version of the ERC721 contract, declaring our <code>donationV1</code> proxy address as the owner:</p>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> app.createProxy(
  MintableERC721Token, 
  tokenClass,
  <span class="hljs-string">'initialize'</span>,
  [donationsV1.address, tokenName, tokenSymbol]
)
</code></pre>
<p>Finally, we set it as the token of our upgradeable contract</p>
<pre><code class="hljs css js"><span class="hljs-keyword">await</span> donationsV1.setToken(token.address)
</code></pre>
<p>That's it! We have upgraded our ZeppelinOS app behavior while preserving its original balance and storage. This new version is also using a proxy contract of the the on-chain ZeppelinOS standard library implementation of a mintable ERC721 token.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/symbol-zeppelin.png" alt="ZeppelinOS" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/start.html">Guides</a><a href="/docs/apis.html">Reference</a></div><div><h5>Community</h5><a href="https://forum.zeppelin.solutions/" target="_blank">Forum</a><a href="https://t.me/zeppelinos/" target="_blank">Telegram chat</a></div><div><h5>More</h5><a href="https://zeppelinos.org">Main Site</a><a href="https://blog.zeppelinos.org">Blog</a><a href="https://github.com/zeppelinos">GitHub</a></div></section><a href="https://zeppelinos.org" target="_blank" class="fbOpenSource"><img src="/img/logo.svg" alt="ZeppelinOS" width="170" height="45"/></a><section class="copyright">Copyright © 2017-present ZeppelinOS Global</section><section class="report-bugs"><a href="https://github.com/zeppelinos/zos/issues/new?labels=kind:documentation">Report a bug on this site</a></section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
              var search = docsearch({
                
                apiKey: '8d0b5afbba49947d9efb5659d1b08df7',
                indexName: 'zeppelinos',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>