<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Crafty · ZeppelinOS</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="Crafty · ZeppelinOS"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.zeppelinos.org/index.html"/><meta property="og:description" content="Have you ever wondered what may happen if you combined an Aragon token and fire? A fire-spewing eagle? Burnt chicken? What if Augur&#x27;s oracles were augmented with Decentraland&#x27;s tiles, would they start predicting the real estate market? Now, you no longer need to ponder at these vital questions: the Ethereum community will answer them for you!"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-102575245-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100,200,300,400,500,700,400italic,700italic"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible doc"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.svg" alt="ZeppelinOS"/></a><a href="/versions.html"><h3>2.4.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/2.4.0/start.html" target="_self">Quickstart</a></li><li class=""><a href="/docs/2.4.0/apis.html" target="_self">Reference</a></li><li class=""><a href="https://blog.zeppelinos.org" target="_self">Blog</a></li><li class=""><a href="https://forum.zeppelin.solutions" target="_self">Forum</a></li><li class=""><a href="https://github.com/zeppelinos" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>Crafty</h1></header><article><div><span><p>Have you ever wondered what may happen if you combined an Aragon token and fire? A fire-spewing eagle? Burnt chicken? What if Augur's oracles were augmented with Decentraland's tiles, would they start predicting the real estate market? Now, you no longer need to ponder at these vital questions: the Ethereum community will answer them for you!</p>
<p>In <a href="https://crafty.zeppelin.solutions">Crafty</a>, users can create new ERC20 tokens, with a few added goodies (following <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1046.html">EIP-1046</a>): a picture, and a short description. This allows for each token to have that extra bit of personality that makes something unique. But that's not all: the only way to get these tokens is by crafting them, which requires ingredients (any ERC20!) to be spent. And since the craftable tokens themselves can also be used as ingredients, the posibilities are endless! Not only that, but we'll make all of our contracts upgradeable, to be able to change the code in the future. Wohoo!</p>
<h2><a class="anchor" aria-hidden="true" id="project-setup"></a><a href="#project-setup" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Project setup</h2>
<p>This guide will show you the process of making the contracts in the Crafty game upgradeable by using ZeppelinOS, which we'll install globally to have it available on all our projects.</p>
<pre><code class="hljs css sh">npm install --global zos
</code></pre>
<p>See <a href="setup.html">here</a> for more detailed setup info.</p>
<p>All snippets here were extracted from the public <a href="https://github.com/zeppelinos/crafty">Crafty repository</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="contracts"></a><a href="#contracts" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Contracts</h2>
<p>Crafty works with only two contracts:</p>
<ul>
<li><a href="https://github.com/zeppelinos/crafty/blob/master/contracts/Crafty.sol"><code>Crafty</code></a> itself, containing the game logic (how new recipes are added, how crafting takes place, etc.) plus some role-based access control (<a href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/zos-release/contracts/ownership/rbac/RBAC.sol">RBAC</a>, powered by <a href="https://openzeppelin.org/">OpenZeppelin</a>), for admin tasks, such as deletion of tokens.</li>
<li>The <a href="https://github.com/zeppelinos/crafty/blob/master/contracts/CraftableToken.sol"><code>CraftableToken</code></a>s, a simple extension of a mintable ERC20, which holds token creator data, a URI for metadata, and a list of required ingredients, along with the amounts of each.</li>
</ul>
<p>To better see how these two contracts interact, take a look at <code>Crafty</code>'s <code>craft</code> method, where a user provides the address of a <code>CraftableToken</code> to craft, and <code>Crafty</code> makes sure the required ingredients are consumed before minting it.</p>
<pre><code class="hljs">function craft(CraftableToken _craftable) public {
 <span class="hljs-built_in"> address </span>player = msg.sender;

  uint256 totalSteps = _craftable.getTotalRecipeSteps();
  <span class="hljs-keyword">for</span> (uint i = 0; i &lt; totalSteps; ++i) {
    ERC20 ingredient;
    uint256 amountNeeded;
    (ingredient, amountNeeded) = _craftable.getRecipeStep(i);

    ingredient.transferFrom(player, address(this), amountNeeded);
  }

  _craftable.mint(player, 1);
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="developing-with-zeppelinos"></a><a href="#developing-with-zeppelinos" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Developing with ZeppelinOS</h2>
<p>So, how would we go about integrating ZeppelinOS in such a project? The process is remarkably simple: we'll cover it step by step. But before we get started, let's initialize our project with ZeppelinOS:</p>
<pre><code class="hljs css sh">zos init Crafty
</code></pre>
<p>This will create a <code>zos.json</code> file, which will store how your project is structured in ZeppelinOS: you'll probably want to commit this file to your project's repository.</p>
<h3><a class="anchor" aria-hidden="true" id="making-crafty-upgradeable"></a><a href="#making-crafty-upgradeable" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Making Crafty upgradeable</h3>
<p>There are multiple reasons to upgrade <code>Crafty</code>'s game logic contract: bug-fixing, adding new functionalities, adjusting to newer developments and ecosystem changes, etc. Remember how <code>Crafty</code> uses RBAC (role-based access control)? An upgrade could easily add new roles, such as a <code>curator</code> role, which would be in charge of approving new tokens before they are added to the game, or highlighting featured creations to be displayed on the front page. These simple but useful extensions would not be possible without ZeppelinOS.</p>
<p><code>Crafty</code> is a great example of how easy it is to add upgradeability to your project. The only change that we need to make is a minor one: the constructor must be replaced with an <code>initialize</code> function.</p>
<pre><code class="hljs css js"><span class="hljs-keyword">import</span> <span class="hljs-string">'openzeppelin-zos/contracts/ownership/rbac/RBAC.sol'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'zos-lib/contracts/migrations/Initializable.sol'</span>;

contract Crafty is RBAC, Initializable {

  <span class="hljs-comment">// moved standard constructor logic to initializer function</span>
  <span class="hljs-comment">// function Crafty() public {</span>
  <span class="hljs-comment">//   addRole(msg.sender, ROLE_ADMIN);</span>
  <span class="hljs-comment">// }</span>

  <span class="hljs-comment">// Initializer for integration with ZeppelinOS</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initialize</span>(<span class="hljs-params">address _initialAdmin</span>) <span class="hljs-title">isInitializer</span> <span class="hljs-title">public</span> </span>{
    addRole(_initialAdmin, ROLE_ADMIN);
  }
  ...
}
</code></pre>
<p>The <code>isInitializer</code> modifier will make sure your <code>initialize</code> method is only called once in the whole lifetime of your contract. But you must remember to explicitly call it, since unlike constructors, <code>initialize</code> methods are not automatically called at contract creation.</p>
<p>Also, note how we are using <code>openzeppelin-zos</code>, instead of the usual <code>openzeppelin-solidity</code>. This package's contracts have been adapted for ZeppelinOS compatibility, and should be the ones used when dealing with upgradeable contracts.</p>
<p>Both <code>zos-lib</code> (for the <code>Initializable</code> contract) and <code>openzeppelin-zos</code> can be installed using <a href="https://www.npmjs.com/">npm</a>:</p>
<pre><code class="hljs css sh">npm install zos-lib openzeppelin-zos
</code></pre>
<p>With the <code>initialize</code> change in place, we're all set to start using upgradeable instances of the <code>Crafty</code> contract! First, we <code>add</code> it to the project's contracts, and then <code>push</code> the compiled bytecode of the current version to the blockchain.</p>
<pre><code class="hljs css sh">zos add Crafty
zos push --network ropsten --from <span class="hljs-variable">$OWNER</span>
</code></pre>
<p>The <code>from</code> parameter is important, since that address is the one that will be allowed to perform upgades to the contract.</p>
<p>We can now <code>create</code> new upgradeable instances, all of which will use the same deployed bytecode, but are entirely independent otherwise. The <code>initialize</code> function can be called in this same step (with the <code>initialAdmin</code> argument), saving you the need to do it manually.</p>
<pre><code class="hljs css sh">zos create Crafty --init --args <span class="hljs-variable">$OWNER</span> --network ropsten
&gt; 0x31C4B...
</code></pre>
<p>The returned value is the address of the newly created <code>Crafty</code> upgradeable instance, which is already initialized and can be safely used, with the peace of mind that it can later be upgraded at any point in time.</p>
<h3><a class="anchor" aria-hidden="true" id="making-craftabletoken-upgradeable"></a><a href="#making-craftabletoken-upgradeable" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Making CraftableToken upgradeable</h3>
<p>This scenario is a bit more complex, since multiple ZeppelinOS contracts are being combined together, but it is nonetheless fairly easy to setup. Let's first recap what a <code>CraftableToken</code> is:</p>
<ol>
<li>It is detailed ERC20 token (i.e. has name and symbol)</li>
<li>It supports the <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1046.html">EIP-1046</a> extension of the ERC20 standard (i.e. we'll add a <code>tokenURI</code> parameter and variable)</li>
<li>It is mintable</li>
<li>It has additional storage of the token's ingredients, which require some validation</li>
</ol>
<p>Luckily for us, OpenZeppelin provides contracts that will implement 1 and 3 for us: <code>DetailedERC20</code> and <code>MintableToken</code>. 2 and 4 we'll have to cover on our own, but the process barely differs from what it would look like without ZeppelinOS.</p>
<p>The EIP-1046 extension is straightforward: we'll inherit from OpenZeppelin's <code>DetailedERC20</code> and add the required variable to our contract. The only difference is, once again, that we need to define an <code>initialize</code> method instead of a constructor, and call our base contracts' <code>initialize</code> methods in it.</p>
<pre><code class="hljs">import <span class="hljs-string">'openzeppelin-zos/contracts/token/ERC20/DetailedERC20.sol'</span>;

contract ExtendedERC20 is DetailedERC20 {
  string public tokenURI;

  function initialize(address <span class="hljs-variable">_sender</span>, string <span class="hljs-variable">_name</span>, string <span class="hljs-variable">_symbol</span>, uint8 <span class="hljs-variable">_decimals</span>, string <span class="hljs-variable">_tokenURI</span>) isInitializer(<span class="hljs-string">'ExtendedERC20'</span>, <span class="hljs-string">'0'</span>) public {
    DetailedERC20.initialize(<span class="hljs-variable">_sender</span>, <span class="hljs-variable">_name</span>, <span class="hljs-variable">_symbol</span>, <span class="hljs-variable">_decimals</span>);
    tokenURI = <span class="hljs-variable">_tokenURI</span>;
  }
}
</code></pre>
<p>Since <code>DetailedERC20</code> already has the <code>isInitializer</code> modifier, we don't need to import it again. Note however, that we were required to supply two arguments: a contract name and a version id.</p>
<p>The additional storage and validations will be implemented in the <code>CraftableToken</code> contract itself, which will feature multiple inheritance. Again, all that needs to be done is to call the <code>initialize</code> method of all base contracts.</p>
<pre><code class="hljs">import <span class="hljs-string">'openzeppelin-zos/contracts/token/ERC20/MintableToken.sol'</span>;
import <span class="hljs-string">'./ExtendedERC20.sol'</span>;

contract CraftableToken is MintableToken, ExtendedERC20 {
  function initialize(address <span class="hljs-variable">_owner</span>, string <span class="hljs-variable">_name</span>, string <span class="hljs-variable">_symbol</span>, string <span class="hljs-variable">_tokenURI</span>, ERC20[] <span class="hljs-variable">_ingredients</span>, uint256[] <span class="hljs-variable">_ingredientAmounts</span>) isInitializer(<span class="hljs-string">'CraftableToken'</span>, <span class="hljs-string">'0'</span>) public {
    MintableToken.initialize(<span class="hljs-variable">_owner</span>);
    ExtendedERC20.initialize(<span class="hljs-variable">_name</span>, <span class="hljs-variable">_symbol</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">_tokenURI</span>);

    <span class="hljs-comment">// Do custom validation on _ingredients and _ingredientAmounts, and store them</span>
    ...
    }
  }
  ...
}
</code></pre>
<p><code>initialize</code>'s arguments can be passed in JSON to <code>create</code>, so arrays are not an issue:</p>
<pre><code class="hljs css sh">zos create CraftableToken --init --args <span class="hljs-string">"0x0cbd7..., \"Crafty Token\", \"CRFT\", \"https://path.to.metadata\", [0xd03ea..., 0x28a87...], [2, 4]"</span> --network ropsten
&gt; 0xaca94...
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="using-our-upgradeable-contracts"></a><a href="#using-our-upgradeable-contracts" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using our upgradeable contracts</h2>
<p>All that remains is having our contracts interact with each other. We'll want <code>Crafty</code> to store the different <code>CraftableToken</code>s so that they can be later listed by a player of the game: let's look at two different ways this could be done.</p>
<p>First, we can have a player pass all of the arguments to a <code>Crafty</code> function, which will create a new <code>CraftableToken</code>, and add it to the list of tokens. Because we didn't create this instance with <code>zos create</code>, it is not upgradeable. Note how we need to call <code>initialize</code>, since <code>CraftableToken</code> doesn't have a constructor anymore.</p>
<pre><code class="hljs css js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addCraftable</span>(<span class="hljs-params">string _name, string _symbol, string _tokenURI, ERC20[] _ingredients, uint256[] _ingredientAmounts</span>) <span class="hljs-title">public</span> <span class="hljs-title">returns</span> (<span class="hljs-params">CraftableToken</span>) </span>{
  <span class="hljs-built_in">require</span>(_ingredients.length == _ingredientAmounts.length);
  <span class="hljs-built_in">require</span>(_ingredients.length &gt; <span class="hljs-number">0</span>);

  CraftableToken newCraftable = <span class="hljs-keyword">new</span> CraftableToken();
  newCraftable.initialize(address(<span class="hljs-keyword">this</span>), _name, _symbol, _tokenURI, _ingredients, _ingredientAmounts);

  craftables.push(newCraftable);

  emit CraftableAdded(newCraftable);

  <span class="hljs-keyword">return</span> newCraftable;
}
</code></pre>
<p>What if we wanted to use the upgradeble instances we have <code>create</code>d with <code>zos</code>? We'll let admins add them into the game by simply providing the address of the contract.</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addPrecreatedCraftable</span><span class="hljs-params">(CraftableToken _craftable)</span> <span class="hljs-title">onlyRole</span><span class="hljs-params">(ROLE_ADMIN)</span> <span class="hljs-title">public</span> </span>{
  craftables.push(_craftable);
  emit CraftableAdded(_craftable);
}
</code></pre>
<p>A key point here is that both the upgradeable and non-upgradeable instances are treated in the same manner: <code>Crafty</code>'s <code>craft</code> method makes no distinction whatsoever when calling <code>CraftableToken</code> methods, since the interface is the same. A contract being upgradeable places no extra burden on its callers.</p>
<p>This example shows how to add upgradeability and use on-chain standard libraries on a fairly complex smart contract app without too much work. Congratulations!</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/symbol-zeppelin.png" alt="ZeppelinOS" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/start.html">Guides</a><a href="/docs/apis.html">Reference</a></div><div><h5>Community</h5><a href="https://forum.zeppelin.solutions/" target="_blank">Forum</a><a href="https://t.me/zeppelinos/" target="_blank">Telegram chat</a></div><div><h5>More</h5><a href="https://zeppelinos.org">Main Site</a><a href="https://blog.zeppelinos.org">Blog</a><a href="https://github.com/zeppelinos">GitHub</a></div></section><a href="https://zeppelinos.org" target="_blank" class="fbOpenSource"><img src="/img/logo.svg" alt="ZeppelinOS" width="170" height="45"/></a><section class="copyright">Copyright © 2017-present ZeppelinOS Global</section><section class="report-bugs"><a href="https://github.com/zeppelinos/zos/issues/new?labels=kind:documentation">Report a bug on this site</a></section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
              var search = docsearch({
                
                apiKey: '8d0b5afbba49947d9efb5659d1b08df7',
                indexName: 'zeppelinos',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>