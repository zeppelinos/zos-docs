<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Upgrading your project · ZeppelinOS</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="Upgrading your project · ZeppelinOS"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.zeppelinos.org/index.html"/><meta property="og:description" content="At the end of the [previous guide](deploying) we deployed a ZeppelinOS"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-102575245-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100,200,300,400,500,700,400italic,700italic"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible doc"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.svg" alt="ZeppelinOS"/></a><a href="/versions.html"><h3>2.4.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/2.4.0/start.html" target="_self">Quickstart</a></li><li class=""><a href="/docs/2.4.0/apis.html" target="_self">Reference</a></li><li class=""><a href="https://blog.zeppelinos.org" target="_self">Blog</a></li><li class=""><a href="https://forum.zeppelin.solutions" target="_self">Forum</a></li><li class=""><a href="https://github.com/zeppelinos" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>Upgrading your project</h1></header><article><div><span><p>At the end of the <a href="deploying">previous guide</a> we deployed a ZeppelinOS
project with one contract. Here is the code of the contract, to keep it fresh
on our minds:</p>
<pre><code class="hljs css solidity"><span class="hljs-keyword">pragma</span> solidity ^<span class="hljs-number">0.5</span>.0;

<span class="hljs-keyword">import</span> <span class="hljs-string">"zos-lib/contracts/Initializable.sol"</span>;

contract MyContract <span class="hljs-keyword">is</span> Initializable {

  uint256 <span class="hljs-keyword">public</span> x;
  <span class="hljs-built_in">string</span> <span class="hljs-keyword">public</span> s;

  <span class="hljs-built_in">function</span> initialize(uint256 _x, <span class="hljs-built_in">string</span> memory _s) initializer <span class="hljs-keyword">public</span> {
    x = _x;
    s = _s;
  }
}
</code></pre>
<p>This is a traditional immutable contract that will remain frozen for ever on
the blockchain, with mistakes, limited functionalities and everything.
ZeppelinOS lets us opt-in to allow upgrades on our contracts, and open the
doors to a more sustainable process for developing our projects. With upgrades
we can make iterative releases, quickly adding small pieces of functionalities
that we can adjust according to the always changing goals of our users; and of
course, we can add fixes for any bugs we introduced on previous iterations. And
just as with any other contract on the blockchain, we can define governance
mechanisms to decide when and how to upgrade the contracts, that can be manual,
automated, or any combination of both that will earn the trust of our users.</p>
<blockquote>
<p>If any of the following commands fail with an <code>A network name must be provided to execute the requested action</code> error, it means our session has expired.
In that case, renew it by running the command <code>npx zos session --network local --from 0x1df62f291b2e969fb0849d99d9ce41e2f137006e --expires 3600</code> again.</p>
</blockquote>
<p>Now let's create an upgradeable instance of this contract so you can
experiment with what this is all about:</p>
<pre><code class="hljs css console">npx zos create MyContract --init initialize --args 42,hitchhiker
</code></pre>
<p>The <code>npx zos create</code> command receives an optional <code>--init [function-name]</code>
parameter to call the initialization function after creating the contract,
and the <code>--args</code> parameter allows you to pass arguments to it. This way, you
are initializing your contract with <code>42</code> as the value of the <code>x</code> state
variable and <code>hitchhiker</code> as the value of the <code>s</code> state variable.</p>
<p>This command will print the address of your contract, and it will update the
<code>zos.dev-&lt;network_id&gt;.json</code> file.</p>
<blockquote>
<p><strong>Note</strong>: When calling an initializer with many variables, these should be
passed as a comma-separated list, with no spaces in between.</p>
</blockquote>
<p>We can start a console to interact with our contract and check that it has been properly initialized:</p>
<pre><code class="hljs css console">npx truffle console --network local
</code></pre>
<p>Once in the Truffle console, execute the following instructions to test
that our instance is working as expected:</p>
<blockquote>
<p><em>Make sure you replace &lt;your-contract-address&gt; with the address returned
by the <code>create</code> command we ran above.</em></p>
</blockquote>
<pre><code class="hljs css console"><span class="hljs-meta">truffle(local)&gt;</span><span class="bash"> myContract = await MyContract.at(<span class="hljs-string">'&lt;your-contract-address&gt;'</span>)</span>
<span class="hljs-meta">truffle(local)&gt;</span><span class="bash"> (await myContract.x()).toString()</span>
'42'
<span class="hljs-meta">
truffle(local)&gt;</span><span class="bash"> myContract.s()</span>
"hitchhiker"
</code></pre>
<p>You can now exit the Truffle console and continue with the following steps.</p>
<h2><a class="anchor" aria-hidden="true" id="upgrading-the-contract"></a><a href="#upgrading-the-contract" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrading the contract</h2>
<p>Remember that for this guide we are using a <a href="https://truffleframework.com/docs/ganache/quickstart">ganache</a>
local development network. Do not stop the <code>ganache-cli</code> command that <a href="/docs/2.4.0/deploying.html#deploying-your-project">we ran before</a>,
or you will lose your previous deployment!</p>
<p>Now, let's say we found an issue on our contract, or maybe we just want to
extend its functionalities.</p>
<p>Open <code>contracts/MyContract.sol</code>, and add a new function:</p>
<pre><code class="hljs css solidity"><span class="hljs-keyword">pragma</span> solidity ^<span class="hljs-number">0.5</span>.0;

<span class="hljs-keyword">import</span> <span class="hljs-string">"zos-lib/contracts/Initializable.sol"</span>;

contract MyContract <span class="hljs-keyword">is</span> Initializable {

  uint256 <span class="hljs-keyword">public</span> x;
  <span class="hljs-built_in">string</span> <span class="hljs-keyword">public</span> s;

  <span class="hljs-built_in">function</span> initialize(uint256 _x, <span class="hljs-built_in">string</span> memory _s) initializer <span class="hljs-keyword">public</span> {
    x = _x;
    s = _s;
  }

  <span class="hljs-built_in">function</span> increment() <span class="hljs-keyword">public</span> {
    x += <span class="hljs-number">1</span>;
  }
}
</code></pre>
<blockquote>
<p><strong>Note</strong>: While ZeppelinOS supports arbitrary changes regarding functionality,
you will need to preserve all the variables that appeared in previous versions of
your contracts, declaring any new variables below the already existing ones.
All the considerations and some recommendations for your upgrades are
explained in the <a href="/docs/2.4.0/writing_contracts.html">Writing upgradeable contracts</a> page.</p>
</blockquote>
<p>Once you have saved these changes, push the new code to the network:</p>
<pre><code class="hljs css console">npx zos push
</code></pre>
<p>Finally, let's update the already deployed contract with the new code:</p>
<pre><code class="hljs css console">npx zos update MyContract
</code></pre>
<p>You will see that this command prints the same contract address as before,
and a logic contract address that is new. This is all the magic behind
upgrades: we have two contracts, one is the contract address that we will
never change, but it just serves as a proxy to the logic contract that we
can replace with new versions.</p>
<p>We can start a new Truffle console to interact with our contract and check
that it has been properly upgraded:</p>
<pre><code class="hljs css console">npx truffle console --network local
</code></pre>
<p>Once in the Truffle console, execute the following instructions to try
the new functionality we've just added:</p>
<blockquote>
<p><em>Make sure you replace &lt;your-contract-address&gt; with the address of the
upgradeable instance your created of <code>MyContract</code>. This address was
returned by the <code>create</code> command we ran in the previous section, which
is the same as the one returned by the <code>update</code> command we ran above.</em></p>
</blockquote>
<pre><code class="hljs css console"><span class="hljs-meta">truffle(local)&gt;</span><span class="bash"> myContract = await MyContract.at(<span class="hljs-string">'&lt;your-contract-address&gt;'</span>)</span>
<span class="hljs-meta">truffle(local)&gt;</span><span class="bash"> myContract.increment()</span>
<span class="hljs-meta">truffle(local)&gt;</span><span class="bash"> (await myContract.x()).toString()</span>
43
</code></pre>
<p>Now let's imagine that instead of just adding a new
function to the contract (a change to functionality), we wanted to add a new
variable <code>t</code> to our contract. But how do we set the initial value of <code>t</code>?
The variables <code>x</code> and <code>s</code> were initialized with the <code>initialize</code> function,
which was called when the proxy was created via the <code>zos create MyContract --init initialize --args ...</code>
command. Naturally, the solution would be to add the initialization of <code>t</code>
to the end of the initialize function:</p>
<pre><code class="hljs">function initialize(uint256 <span class="hljs-variable">_x</span>, string memory <span class="hljs-variable">_s</span>, uint256 <span class="hljs-variable">_t</span>) initializer public {
  x = <span class="hljs-variable">_x</span>;
  s = <span class="hljs-variable">_s</span>;
  t = <span class="hljs-variable">_t</span>;
}
</code></pre>
<p>That would be fine for newly deployed instances of MyContract, but it wouldn't work for one that
has allready been deployed, and is instead being updated. We cannot call the same <code>initialize</code> function, because
the <code>Initializable</code> modifier guards it against being called more than once. We need a new function.</p>
<p>The <code>update</code> command also accepts <code>--init</code> and <code>--args</code> parameters, so we can use a function
with it to initialize the new variable. A good name for the
new function could be something like <code>initializeT</code> or <code>initializeVersion2</code>. This function would simply
set the initial value of <code>t</code> and check that it has not yet been initialized. It should be called with <code>zos update MyContract --init initializeT --args 99</code>.</p>
<pre><code class="hljs"><span class="hljs-function">function <span class="hljs-title">initializeT</span><span class="hljs-params">(uint256 <span class="hljs-keyword">_t</span>)</span> <span class="hljs-keyword">public</span> </span>{
  require(t == <span class="hljs-number">0</span>);
  t = <span class="hljs-keyword">_t</span>;
}
</code></pre>
<p>This initialization validation for <code>t</code>, of course, would only make sense if <code>t</code> cannot be zero.</p>
<p>The resulting code would be:</p>
<pre><code class="hljs css solidity">pragma solidity ^<span class="hljs-number">0.5</span><span class="hljs-number">.0</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">"zos-lib/contracts/Initializable.sol"</span>;

contract MyContract is Initializable {

  uint256 <span class="hljs-keyword">public</span> x;
  <span class="hljs-built_in">string</span> <span class="hljs-keyword">public</span> s;
  uint256 <span class="hljs-keyword">public</span> t;

  <span class="hljs-function">function <span class="hljs-title">initialize</span><span class="hljs-params">(uint256 _x, <span class="hljs-built_in">string</span> memory _s, uint256 <span class="hljs-keyword">_t</span>)</span> initializer <span class="hljs-keyword">public</span> </span>{
    x = _x;
    s = _s;
    t = <span class="hljs-keyword">_t</span>;
  }

  <span class="hljs-function">function <span class="hljs-title">initializeT</span><span class="hljs-params">(uint256 <span class="hljs-keyword">_t</span>)</span> <span class="hljs-keyword">public</span> </span>{
    require(t == <span class="hljs-number">0</span>);
    t = <span class="hljs-keyword">_t</span>;
  }

  <span class="hljs-function">function <span class="hljs-title">increment</span><span class="hljs-params">()</span> <span class="hljs-keyword">public</span> </span>{
    x += <span class="hljs-number">1</span>;
  }
}
</code></pre>
<p>Upgrades are only one of the features of ZeppelinOS. Next, we will see another
very interesting feature, because it allows us to reuse packages that have been
already deployed to the blockchain.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/symbol-zeppelin.png" alt="ZeppelinOS" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/start.html">Guides</a><a href="/docs/apis.html">Reference</a></div><div><h5>Community</h5><a href="https://forum.zeppelin.solutions/" target="_blank">Forum</a><a href="https://t.me/zeppelinos/" target="_blank">Telegram chat</a></div><div><h5>More</h5><a href="https://zeppelinos.org">Main Site</a><a href="https://blog.zeppelinos.org">Blog</a><a href="https://github.com/zeppelinos">GitHub</a></div></section><a href="https://zeppelinos.org" target="_blank" class="fbOpenSource"><img src="/img/logo.svg" alt="ZeppelinOS" width="170" height="45"/></a><section class="copyright">Copyright © 2017-present ZeppelinOS Global</section><section class="report-bugs"><a href="https://github.com/zeppelinos/zos/issues/new?labels=kind:documentation">Report a bug on this site</a></section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
              var search = docsearch({
                
                apiKey: '8d0b5afbba49947d9efb5659d1b08df7',
                indexName: 'zeppelinos',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>